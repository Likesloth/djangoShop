{% extends 'myapp/layout/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Request #{{ pr.id }}</h2>
  <p>
    Requester: <strong>{{ pr.requester.username }}</strong> •
    Status: <span class="badge bg-secondary">{{ pr.get_status_display }}</span> •
    Pickup location: {{ pr.pickup_location|default:'Main Desk' }} •
    Pickup by: {{ pr.pickup_by|date:'Y-m-d' }}
  </p>

  <h5>Items</h5>
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Assigned Copy</th>
        <th>Assign</th>
      </tr>
    </thead>
    <tbody>
      {% for it in pr.items.all %}
        <tr>
          <td>{{ it.book.title }}</td>
          <td>
            {% if it.assigned_copy %}
              {{ it.assigned_copy.barcode }}
              <form method="post" action="{% url 'staff-request-unassign-item' pr.id it.id %}" class="d-inline ms-2">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger" type="submit">Unassign</button>
              </form>
            {% else %}
              <em>Not assigned</em>
            {% endif %}
          </td>
          <td>
            <form method="post" action="{% url 'staff-request-assign-item' pr.id it.id %}" class="d-flex gap-2">
              {% csrf_token %}
              <input type="text" name="barcode" placeholder="Scan/enter barcode" class="form-control form-control-sm"/>
              <button class="btn btn-sm btn-outline-success" type="submit">Assign</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'staff-requests-queue' %}">Back</a>
    <form method="post" action="{% url 'staff-request-mark-ready' pr.id %}">
      {% csrf_token %}
      <button class="btn btn-primary" type="submit">Mark Ready</button>
    </form>
    <form method="post" action="{% url 'staff-request-confirm-pickup' pr.id %}">
      {% csrf_token %}
      <button class="btn btn-success" type="submit">Confirm Pickup</button>
    </form>
    <form method="post" action="{% url 'staff-request-cancel' pr.id %}">
      {% csrf_token %}
      <button class="btn btn-danger" type="submit">Cancel</button>
    </form>
  </div>
</div>
{% endblock %}
